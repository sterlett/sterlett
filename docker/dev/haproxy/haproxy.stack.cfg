global
    log stdout format raw local0 debug
    pidfile /var/run/haproxy.pid
    maxconn 10000
    master-worker

resolvers docker
    nameserver dns1 127.0.0.11:53

defaults
    log global
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    mode http
    option httpchk GET / HTTP/1.1
    http-check send hdr Host "haproxy-health-check"
    http-check expect status 200
    option httplog

frontend web
    bind *:80

    acl PATH_stats path_beg -i /stats
    acl PATH_api path_beg -i /api

    use_backend be_stats if PATH_stats
    use_backend be_api if PATH_api
    default_backend be_static

backend be_stats
    stats enable
    stats uri /stats
    stats auth haproxy:haproxy
    stats admin if TRUE
    stats refresh 30s
    stats show-legends
    stats show-node

backend be_static
    balance roundrobin
    server static lighttpd:6635 check inter 5000 resolvers docker init-addr libc,none
    option httpclose

backend be_api
    balance roundrobin
    server-template app 3 app:6636 check inter 5000 resolvers docker init-addr libc,none
    option httpclose
